<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SYNCWAVE v8 | REPAIRED</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons (Reliable Source) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        body { 
            background-color: #050505; 
            color: white; 
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        /* Glass UI */
        .glass {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Slider */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #a855f7; margin-top: -8px; cursor: pointer; border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border-radius: 2px; }

        /* Debug Log */
        #debug-console {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0,0,0,0.9); border-top: 1px solid #333;
            font-family: monospace; font-size: 10px; color: #0f0;
            padding: 8px; overflow-y: auto; z-index: 9999;
            display: none; /* Hidden by default, toggleable */
        }
        .log-err { color: #ff5555; }
        .log-info { color: #55ffff; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-full flex items-center justify-center p-4">

    <!-- GLOBAL ERROR HANDLER UI -->
    <div id="crash-screen" class="hidden fixed inset-0 bg-red-900/90 z-[9999] flex flex-col items-center justify-center p-8 text-center">
        <h1 class="text-2xl font-bold text-white mb-4">SYSTEM FAILURE</h1>
        <p id="crash-reason" class="font-mono text-xs text-red-200 bg-black/50 p-4 rounded mb-4">Unknown Error</p>
        <button onclick="location.reload()" class="bg-white text-red-900 px-6 py-3 rounded font-bold">RELOAD</button>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="w-full max-w-md h-full flex flex-col relative opacity-0 transition-opacity duration-500">
        
        <!-- HEADER -->
        <header class="flex justify-between items-center mb-8 pt-4">
            <div>
                <h1 class="text-2xl font-black tracking-tighter text-white">SYNCWAVE</h1>
                <div class="flex items-center gap-2">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-yellow-500"></div>
                    <p id="status-text" class="text-[10px] font-bold text-slate-500 tracking-widest">CONNECTING...</p>
                </div>
            </div>
            <button onclick="App.toggleLog()" class="p-2 bg-slate-800 rounded-full text-slate-400">
                <i data-lucide="terminal" class="w-4 h-4"></i>
            </button>
        </header>

        <!-- VIEW: LOBBY -->
        <div id="view-lobby" class="flex-1 flex flex-col justify-center gap-6">
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-slate-500 uppercase">Your Name</label>
                <input type="text" id="username-in" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-4 text-white font-bold outline-none focus:border-purple-500" placeholder="Enter DJ Name">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="App.createRoom()" class="glass p-6 rounded-2xl flex flex-col items-center gap-3 hover:bg-purple-900/40 transition-all active:scale-95 group">
                    <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center shadow-lg shadow-purple-500/30 group-hover:scale-110 transition-transform">
                        <i data-lucide="radio" class="w-6 h-6 text-white"></i>
                    </div>
                    <span class="font-bold text-sm">HOST</span>
                </button>

                <button onclick="App.showJoin()" class="glass p-6 rounded-2xl flex flex-col items-center gap-3 hover:bg-blue-900/40 transition-all active:scale-95 group">
                    <div class="w-12 h-12 bg-slate-700 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i data-lucide="headphones" class="w-6 h-6 text-white"></i>
                    </div>
                    <span class="font-bold text-sm">JOIN</span>
                </button>
            </div>

            <!-- Join Input -->
            <div id="join-drawer" class="hidden flex gap-2 animate-bounce-in">
                <input type="text" id="code-in" class="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white font-mono uppercase tracking-widest outline-none" placeholder="ROOM CODE">
                <button onclick="App.joinRoom()" class="bg-blue-600 px-6 rounded-xl font-bold">GO</button>
            </div>
        </div>

        <!-- VIEW: PLAYER -->
        <div id="view-player" class="hidden flex-1 flex-col relative">
            
            <!-- Info -->
            <div class="glass p-4 rounded-2xl mb-6 flex justify-between items-center">
                <div>
                    <p class="text-[10px] text-slate-500 font-bold uppercase">FREQUENCY</p>
                    <p id="room-display" class="text-xl font-mono font-bold text-white tracking-widest cursor-pointer" onclick="App.copyCode()">----</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-slate-500 font-bold uppercase">LATENCY</p>
                    <p id="offset-display" class="text-xs font-bold text-blue-400">0ms</p>
                </div>
            </div>

            <!-- Visualizer -->
            <div class="flex-1 flex flex-col items-center justify-center mb-8">
                <div class="relative w-48 h-48 mb-6">
                    <div id="viz-pulse" class="absolute inset-0 bg-purple-600 rounded-full opacity-0 blur-2xl transition-opacity duration-200"></div>
                    <div class="absolute inset-0 bg-slate-900 rounded-full border-4 border-slate-800 flex items-center justify-center z-10 shadow-2xl overflow-hidden">
                        <i data-lucide="music" class="w-20 h-20 text-slate-700"></i>
                    </div>
                </div>
                <h2 id="track-name" class="text-xl font-bold text-white mb-1 text-center truncate w-full px-4">No Track Selected</h2>
                <p id="track-status" class="text-xs font-mono text-slate-500 uppercase tracking-widest">Idle</p>
            </div>

            <!-- CONTROLS -->
            <div class="mt-auto space-y-4">
                
                <!-- HOST -->
                <div id="host-controls" class="hidden flex-col gap-3">
                    <select id="track-select" onchange="App.selectTrack()" class="w-full bg-slate-800 text-sm px-4 py-4 rounded-xl border border-slate-700 text-white outline-none">
                        <option value="">Select Music...</option>
                        <option value="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3">Neon Blade (Electronic)</option>
                        <option value="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3">Night Drive (Lofi)</option>
                        <option value="https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3">Epic Cinematic (Orchestral)</option>
                    </select>
                    <button id="play-btn" onclick="App.togglePlay()" class="w-full py-4 bg-white text-black font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
                        START SESSION (5s Delay)
                    </button>
                </div>

                <!-- GUEST -->
                <div id="guest-controls" class="hidden">
                    <button id="unlock-btn" onclick="App.unlockAudio()" class="w-full py-4 bg-purple-600 text-white font-bold rounded-xl shadow-lg shadow-purple-900/50 animate-pulse active:scale-95 transition-transform">
                        TAP TO READY AUDIO
                    </button>
                    <p id="waiting-msg" class="hidden text-center text-xs text-slate-400 mt-2">AUDIO READY. WAITING FOR HOST...</p>
                </div>

                <!-- MANUAL FIX -->
                <div class="glass p-3 rounded-2xl mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Latency Fix</span>
                    </div>
                    <div class="flex gap-3 items-center">
                        <button onclick="App.nudge(-50)" class="w-8 h-8 bg-slate-700 rounded flex items-center justify-center active:bg-slate-600"><i data-lucide="minus" class="w-3 h-3"></i></button>
                        <input type="range" id="offset-slider" min="-2000" max="2000" value="0" step="10" oninput="App.setOffset(this.value)" class="flex-1">
                        <button onclick="App.nudge(50)" class="w-8 h-8 bg-slate-700 rounded flex items-center justify-center active:bg-slate-600"><i data-lucide="plus" class="w-3 h-3"></i></button>
                    </div>
                </div>

            </div>
        </div>

        <!-- LOADER -->
        <div id="loader" class="hidden absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center">
            <div class="w-10 h-10 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
            <p id="loader-msg" class="text-xs font-mono text-purple-400 mt-4 tracking-widest">LOADING...</p>
        </div>

    </div>

    <!-- DEBUG CONSOLE -->
    <div id="debug-console"></div>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GLOBAL ERROR HANDLER
        window.onerror = function(msg, url, line) {
            document.getElementById('crash-screen').classList.remove('hidden');
            document.getElementById('crash-reason').innerText = `${msg}\nLine: ${line}`;
            return false;
        };

        // --- HARDCODED KEYS (YOUR KEYS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDpTPRYhEztZ1SonOHGeKtn9_Luaj3cNIg",
            authDomain: "silent-disco-app.firebaseapp.com",
            projectId: "silent-disco-app",
            storageBucket: "silent-disco-app.firebasestorage.app",
            messagingSenderId: "266369591226",
            appId: "1:266369591226:web:cee570515ae2bf29ff9f83",
            measurementId: "G-MXS4T9LPBL"
        };

        // --- ENGINE ---
        const Core = {
            app: null,
            auth: null,
            db: null,
            user: null,
            room: null,
            role: null,
            
            // Audio
            ctx: null,
            source: null,
            buffer: null,
            
            // Sync
            manualOffset: 0,
            isPlaying: false,
            currentUrl: null,

            // 1. INITIALIZE
            init: () => {
                Core.log("System Initializing...");
                
                try {
                    Core.app = initializeApp(firebaseConfig);
                    Core.auth = getAuth(Core.app);
                    Core.db = getFirestore(Core.app);
                    Core.log("Firebase Initialized");
                } catch (e) {
                    Core.log("Firebase Init Failed: " + e.message, true);
                    return;
                }

                // Auth Listener
                onAuthStateChanged(Core.auth, (u) => {
                    if (u) {
                        Core.user = u;
                        Core.log(`User Logged In: ${u.uid.slice(0,5)}`);
                        Core.updateStatus("ONLINE", "green");
                        
                        // Reveal UI
                        document.getElementById('app').style.opacity = 1;
                        document.getElementById('view-lobby').classList.remove('hidden');
                        document.getElementById('view-lobby').classList.add('flex');
                        
                        // Force Icons
                        setTimeout(() => {
                            if(window.lucide) window.lucide.createIcons();
                            else Core.log("Icons failed to load", true);
                        }, 500);
                    } else {
                        Core.log("User signed out / null");
                        signInAnonymously(Core.auth).catch(e => {
                            Core.log("Anon Auth Failed: " + e.message, true);
                            alert("Auth Failed. Check Console.");
                        });
                    }
                });
            },

            // 2. LOGGING
            log: (msg, isError = false) => {
                const con = document.getElementById('debug-console');
                const line = document.createElement('div');
                line.innerText = `> ${msg}`;
                if (isError) line.className = "log-err";
                else line.className = "log-info";
                con.appendChild(line);
                con.scrollTop = con.scrollHeight;
                console.log(msg);
            },

            updateStatus: (msg, color) => {
                document.getElementById('status-text').innerText = msg;
                document.getElementById('status-dot').className = `w-2 h-2 rounded-full bg-${color}-500`;
            },

            // 3. ROOMS
            createRoom: async () => {
                if(!Core.user) return alert("Waiting for Auth...");
                
                const name = document.getElementById('username-in').value || "Host";
                const code = Math.random().toString(36).substr(2, 6).toUpperCase();
                
                Core.ui.loading(true, "CREATING SERVER...");
                
                try {
                    const roomRef = doc(Core.db, `artifacts/syncwave-v8/public/data/rooms`, code);
                    
                    await setDoc(roomRef, {
                        host: Core.user.uid,
                        hostName: name,
                        track: '',
                        status: 'idle',
                        startTime: 0,
                        updatedAt: serverTimestamp()
                    });
                    
                    // Add Self to users
                    await setDoc(doc(Core.db, `artifacts/syncwave-v8/public/data/rooms`, code, 'users', Core.user.uid), { name });
                    
                    Core.log("Room Created: " + code);
                    Core.role = 'host';
                    Core.enterRoom(code);
                    
                } catch (e) {
                    Core.log("Create Error: " + e.message, true);
                    alert("Error creating room: " + e.message);
                    Core.ui.loading(false);
                }
            },

            joinRoom: async () => {
                if(!Core.user) return alert("Waiting for Auth...");
                
                const code = document.getElementById('code-in').value.toUpperCase();
                const name = document.getElementById('username-in').value || "Guest";
                
                if (code.length < 3) return alert("Invalid Code");
                
                Core.ui.loading(true, "CONNECTING...");
                
                try {
                    const roomPath = `artifacts/syncwave-v8/public/data/rooms`;
                    // Just write user entry to join
                    await setDoc(doc(Core.db, roomPath, code, 'users', Core.user.uid), { name });
                    
                    Core.log("Joined Room: " + code);
                    Core.role = 'guest';
                    Core.enterRoom(code);
                    
                } catch (e) {
                    Core.log("Join Error: " + e.message, true);
                    alert("Error joining: " + e.message);
                    Core.ui.loading(false);
                }
            },

            enterRoom: (code) => {
                Core.room = code;
                document.getElementById('view-lobby').classList.add('hidden');
                document.getElementById('view-player').classList.remove('hidden');
                document.getElementById('view-player').classList.add('flex');
                document.getElementById('room-display').innerText = code;
                
                if (Core.role === 'host') {
                    const hc = document.getElementById('host-controls');
                    hc.classList.remove('hidden');
                    hc.classList.add('flex');
                    Core.initAudio();
                } else {
                    document.getElementById('guest-controls').classList.remove('hidden');
                }
                
                Core.subscribe();
                Core.ui.loading(false);
            },

            // 4. AUDIO
            initAudio: () => {
                if (!Core.ctx) {
                    const AudioCtx = window.AudioContext || window.webkitAudioContext;
                    Core.ctx = new AudioCtx();
                    Core.log("Audio Context Created");
                }
                if (Core.ctx.state === 'suspended') Core.ctx.resume();
            },

            loadTrack: async (url) => {
                document.getElementById('track-status').innerText = "DOWNLOADING...";
                Core.log("Downloading: " + url.substring(0, 20) + "...");
                
                try {
                    const res = await fetch(url);
                    const buf = await res.arrayBuffer();
                    Core.buffer = await Core.ctx.decodeAudioData(buf);
                    
                    document.getElementById('track-name').innerText = "Track Loaded";
                    document.getElementById('track-status').innerText = "READY";
                    Core.log("Track Decoded Successfully");
                    
                    if (Core.role === 'guest') {
                        document.getElementById('waiting-msg').innerText = "READY. WAITING FOR HOST...";
                    }
                } catch (e) {
                    Core.log("Load Error: " + e.message, true);
                    alert("Failed to load track");
                }
            },

            // 5. PLAYBACK
            play: (serverStartTime) => {
                if (!Core.buffer) return;
                
                const now = Date.now();
                const delayMs = (serverStartTime - now) + Core.manualOffset;
                
                if (Core.source) try { Core.source.stop(); } catch(e){}
                Core.source = Core.ctx.createBufferSource();
                Core.source.buffer = Core.buffer;
                Core.source.connect(Core.ctx.destination);
                
                if (delayMs > 0) {
                    // Future Start
                    Core.source.start(Core.ctx.currentTime + (delayMs/1000));
                    document.getElementById('track-status').innerText = `STARTING IN ${(delayMs/1000).toFixed(1)}s`;
                    Core.log("Scheduling Play in " + delayMs + "ms");
                } else {
                    // Past Start (Seek)
                    const seekPos = Math.abs(delayMs) / 1000;
                    Core.source.start(0, seekPos);
                    document.getElementById('track-status').innerText = "PLAYING";
                    Core.log("Playing immediately (catchup " + seekPos + "s)");
                }
                
                Core.isPlaying = true;
                document.getElementById('viz-pulse').style.opacity = 1;
                
                if (Core.role === 'host') document.getElementById('play-btn').innerText = "STOP SESSION";
            },

            stop: () => {
                if (Core.source) try { Core.source.stop(); } catch(e){}
                Core.isPlaying = false;
                document.getElementById('viz-pulse').style.opacity = 0;
                document.getElementById('track-status').innerText = "PAUSED";
                
                if (Core.role === 'host') document.getElementById('play-btn').innerText = "START SESSION (5s Delay)";
            },

            // 6. LOGIC
            togglePlay: async () => {
                if (Core.isPlaying) {
                    await setDoc(doc(Core.db, `artifacts/syncwave-v8/public/data/rooms`, Core.room), { status: 'idle' }, { merge: true });
                } else {
                    const future = Date.now() + 5000; 
                    await setDoc(doc(Core.db, `artifacts/syncwave-v8/public/data/rooms`, Core.room), { 
                        status: 'playing', 
                        startTime: future 
                    }, { merge: true });
                }
            },

            subscribe: () => {
                Core.log("Subscribing to Room Updates...");
                onSnapshot(doc(Core.db, `artifacts/syncwave-v8/public/data/rooms`, Core.room), (snap) => {
                    if (!snap.exists()) return;
                    const d = snap.data();
                    
                    if (d.track && d.track !== Core.currentUrl) {
                        Core.currentUrl = d.track;
                        Core.loadTrack(d.track);
                    }
                    
                    if (d.status === 'playing' && !Core.isPlaying) {
                        Core.play(d.startTime);
                    } else if (d.status === 'idle' && Core.isPlaying) {
                        Core.stop();
                    }
                });
            },

            // UI
            ui: {
                loading: (show, msg) => {
                    const l = document.getElementById('loader');
                    if (show) {
                        l.classList.remove('hidden');
                        document.getElementById('loader-msg').innerText = msg;
                    } else {
                        l.classList.add('hidden');
                    }
                }
            }
        };

        // EXPORT
        window.App = {
            createRoom: Core.createRoom,
            joinRoom: Core.joinRoom,
            showJoin: () => document.getElementById('join-drawer').classList.remove('hidden'),
            toggleLog: () => {
                const l = document.getElementById('debug-console');
                l.style.display = l.style.display === 'block' ? 'none' : 'block';
            },
            
            selectTrack: () => {
                const val = document.getElementById('track-select').value;
                if(val) {
                    setDoc(doc(Core.db, `artifacts/syncwave-v8/public/data/rooms`, Core.room), { track: val, status: 'idle' }, { merge: true })
                        .then(() => Core.loadTrack(val));
                }
            },
            
            togglePlay: Core.togglePlay,
            
            unlockAudio: () => {
                Core.initAudio();
                const b = Core.ctx.createBuffer(1, 1, 22050);
                const s = Core.ctx.createBufferSource();
                s.buffer = b; s.connect(Core.ctx.destination); s.start(0);
                
                document.getElementById('unlock-btn').classList.add('hidden');
                document.getElementById('waiting-msg').classList.remove('hidden');
                if (Core.buffer) document.getElementById('waiting-msg').innerText = "READY. WAITING FOR HOST...";
            },
            
            setOffset: (val) => {
                Core.manualOffset = parseInt(val);
                document.getElementById('offset-display').innerText = `${val}ms`;
            },
            nudge: (val) => {
                const sl = document.getElementById('offset-slider');
                sl.value = parseInt(sl.value) + val;
                window.App.setOffset(sl.value);
            },
            copyCode: () => {
                navigator.clipboard.writeText(Core.room);
                alert("Copied!");
            }
        };

        // Start
        Core.init();

    </script>
</body>
</html>
