<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYNCWAVE | Pro Audio Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #050505; 
            color: white; 
            overflow: hidden;
        }
        
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* Animations */
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; transform: scale(1); box-shadow: 0 0 20px rgba(168, 85, 247, 0.2); }
            50% { opacity: 0.8; transform: scale(0.98); box-shadow: 0 0 10px rgba(168, 85, 247, 0.1); }
        }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .animate-pulse-soft { animation: pulse-soft 3s ease-in-out infinite; }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }

        /* Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #a855f7; margin-top: -6px; cursor: pointer; border: 2px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border-radius: 2px; }

        .glass-panel {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-center relative">

    <!-- Ambient Background -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-20%] left-[-20%] w-[80vw] h-[80vw] bg-purple-900/20 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-20%] right-[-20%] w-[80vw] h-[80vw] bg-blue-900/20 rounded-full blur-[120px]"></div>
    </div>

    <!-- MAIN INTERFACE -->
    <div id="app" class="relative z-10 w-full max-w-md h-full flex flex-col p-6 transition-all duration-500">
        
        <!-- HEADER -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-black tracking-tighter flex items-center gap-2">
                    <span class="w-3 h-3 bg-purple-500 rounded-full animate-pulse"></span>
                    SYNCWAVE
                </h1>
                <p class="text-[10px] text-slate-500 font-mono tracking-widest uppercase mt-1">Latency Killer Engine v3.2</p>
            </div>
            <div id="connection-badge" class="px-2 py-1 rounded bg-red-500/10 border border-red-500/20 text-red-400 text-[9px] font-mono font-bold flex items-center gap-1 cursor-pointer" onclick="app.syncClock()">
                <i data-lucide="refresh-cw" class="w-3 h-3"></i> RESYNC
            </div>
        </header>

        <!-- VIEW 1: LOBBY -->
        <div id="view-landing" class="flex-1 flex flex-col justify-center gap-6 animate-fade-in">
            <!-- Name Input -->
            <div class="space-y-2">
                <label class="text-xs text-slate-400 font-mono ml-1">IDENTIFICATION</label>
                <input type="text" id="username-input" class="w-full bg-black/40 border border-slate-700 focus:border-purple-500 rounded-xl px-4 py-4 text-white text-lg placeholder-slate-600 outline-none transition-all" placeholder="Enter Nickname">
            </div>

            <!-- Action Cards -->
            <div class="grid grid-cols-2 gap-4">
                <button onclick="app.createRoom()" class="glass-panel group p-6 rounded-2xl flex flex-col items-center justify-center gap-3 hover:bg-purple-900/20 hover:border-purple-500/50 transition-all active:scale-95">
                    <div class="w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i data-lucide="radio-tower" class="w-6 h-6 text-purple-400"></i>
                    </div>
                    <span class="font-bold text-sm">HOST PARTY</span>
                </button>

                <button onclick="app.showJoinUI()" class="glass-panel group p-6 rounded-2xl flex flex-col items-center justify-center gap-3 hover:bg-blue-900/20 hover:border-blue-500/50 transition-all active:scale-95">
                    <div class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i data-lucide="headphones" class="w-6 h-6 text-blue-400"></i>
                    </div>
                    <span class="font-bold text-sm">JOIN PARTY</span>
                </button>
            </div>

            <!-- Join Input (Hidden) -->
            <div id="join-form" class="hidden space-y-2 mt-4">
                <label class="text-xs text-slate-400 font-mono ml-1">ROOM FREQUENCY</label>
                <div class="flex gap-2">
                    <input type="text" id="room-code-input" class="flex-1 bg-black/40 border border-slate-700 rounded-xl px-4 py-3 text-white uppercase font-mono tracking-widest outline-none focus:border-blue-500" placeholder="CODE">
                    <button onclick="app.joinRoom()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 rounded-xl font-bold transition-all">
                        CONNECT
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: PLAYER -->
        <div id="view-player" class="hidden flex-1 flex flex-col relative">
            
            <!-- Room Status Bar -->
            <div class="glass-panel rounded-lg p-3 mb-6 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="flex flex-col">
                        <span class="text-[9px] text-slate-400 font-mono">ROOM CODE</span>
                        <span id="display-room-code" class="text-lg font-mono font-bold tracking-wider text-white select-all">---</span>
                    </div>
                </div>
                <div class="text-right">
                    <span id="participant-count" class="text-xs font-bold text-purple-400">1 Online</span>
                    <p id="host-name" class="text-[9px] text-slate-500">Host: You</p>
                </div>
            </div>

            <!-- Album Art / Visualizer -->
            <div class="flex-1 flex flex-col items-center justify-center relative min-h-[250px]">
                <!-- Rings -->
                <div id="viz-ring-1" class="absolute w-64 h-64 border border-purple-500/20 rounded-full opacity-0 scale-50 transition-all duration-1000"></div>
                <div id="viz-ring-2" class="absolute w-48 h-48 border border-purple-500/40 rounded-full opacity-0 scale-50 transition-all duration-1000 delay-100"></div>
                
                <!-- Core -->
                <div class="relative z-10 w-40 h-40 rounded-full bg-gradient-to-tr from-slate-800 to-black border-4 border-slate-800 shadow-2xl flex items-center justify-center overflow-hidden animate-pulse-soft">
                    <img src="https://images.unsplash.com/photo-1614613535308-eb5fbd3d2c17?q=80&w=2070&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-60" alt="cover">
                    <i data-lucide="music" class="w-12 h-12 text-white relative z-20"></i>
                </div>

                <!-- Sync Overlay Button -->
                <div id="tap-to-sync" class="hidden absolute inset-0 z-30 flex items-center justify-center bg-black/80 backdrop-blur-sm rounded-2xl cursor-pointer" onclick="app.unlockAudio()">
                    <div class="bg-green-600 px-8 py-4 rounded-full shadow-[0_0_30px_rgba(22,163,74,0.5)] animate-bounce">
                        <span class="font-bold text-white tracking-widest">TAP TO SYNC</span>
                    </div>
                </div>
            </div>

            <!-- Track Info -->
            <div class="text-center mb-8">
                <h2 id="track-title" class="text-xl font-bold text-white mb-1 truncate">Waiting for Host...</h2>
                <p id="track-status" class="text-xs text-purple-400 font-mono uppercase tracking-widest">System Idle</p>
                <p id="hardware-latency-msg" class="text-[9px] text-yellow-500/80 font-mono mt-1 hidden">Mobile HW Correction: -120ms</p>
            </div>

            <!-- Tech Stats Dashboard -->
            <div class="grid grid-cols-3 gap-2 mb-6">
                <div class="glass-panel p-2 rounded text-center">
                    <p class="text-[8px] text-slate-500 font-mono">OFFSET</p>
                    <p id="stat-offset" class="text-xs font-mono font-bold text-white">0ms</p>
                </div>
                <div class="glass-panel p-2 rounded text-center">
                    <p class="text-[8px] text-slate-500 font-mono">DRIFT</p>
                    <p id="stat-drift" class="text-xs font-mono font-bold text-green-400">0ms</p>
                </div>
                <div class="glass-panel p-2 rounded text-center">
                    <p class="text-[8px] text-slate-500 font-mono">PING</p>
                    <p id="stat-ping" class="text-xs font-mono font-bold text-blue-400">--</p>
                </div>
            </div>

            <!-- Controls (Host Only) -->
            <div id="host-controls" class="hidden flex-col gap-3 mb-4">
                <select id="track-select" onchange="app.selectTrack()" class="w-full bg-slate-800 text-xs px-4 py-3 rounded-lg border border-slate-700 outline-none text-white">
                    <option value="">Select a Track...</option>
                    <option value="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3">Neon Blade (Electronic)</option>
                    <option value="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3">Night Drive (Lofi)</option>
                    <option value="https://cdn.pixabay.com/download/audio/2022/01/18/audio_d0a13f69d2.mp3">Epic Reveal (Cinematic)</option>
                </select>
                <button onclick="app.togglePlayback()" id="play-btn" class="w-full py-4 bg-purple-600 hover:bg-purple-500 rounded-xl font-bold tracking-widest shadow-lg shadow-purple-900/50 transition-all active:scale-95">
                    START SESSION
                </button>
            </div>

            <!-- Manual Sync Slider -->
            <div class="flex items-center gap-3 px-2">
                <button onclick="app.nudgeOffset(-10)" class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-slate-400"><i data-lucide="minus" class="w-3 h-3"></i></button>
                <div class="flex-1 relative">
                    <input type="range" id="offset-slider" min="-500" max="500" value="0" step="10" oninput="app.setManualOffset(this.value)">
                    <div class="w-[1px] h-3 bg-white/20 absolute top-1 left-1/2 -translate-x-1/2 pointer-events-none"></div>
                </div>
                <button onclick="app.nudgeOffset(10)" class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-slate-400"><i data-lucide="plus" class="w-3 h-3"></i></button>
            </div>
            <p class="text-[9px] text-center text-slate-600 mt-2">Manual Sync Nudge (Use if Late/Early)</p>

        </div>

        <!-- Fullscreen Loader -->
        <div id="loader" class="hidden absolute inset-0 bg-black/90 backdrop-blur-xl z-50 flex flex-col items-center justify-center">
            <div class="w-10 h-10 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
            <p id="loader-msg" class="text-xs font-mono text-purple-400 mt-4 animate-pulse">SYSTEM INITIALIZING...</p>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDpTPRYhEztZ1SonOHGeKtn9_Luaj3cNIg",
            authDomain: "silent-disco-app.firebaseapp.com",
            projectId: "silent-disco-app",
            storageBucket: "silent-disco-app.firebasestorage.app",
            messagingSenderId: "266369591226",
            appId: "1:266369591226:web:cee570515ae2bf29ff9f83"
        };

        // Fallback for canvas environment
        let config = firebaseConfig;
        let appId = 'beat-sync-v3';
        try {
            if (typeof window.parent !== 'undefined' && window.parent.__firebase_config) {
                config = JSON.parse(window.parent.__firebase_config);
            }
            if (typeof window.parent !== 'undefined' && window.parent.__app_id) {
                appId = window.parent.__app_id;
            }
        } catch (e) {}

        const app = initializeApp(config);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ROOMS_COL = `artifacts/${appId}/public/data/rooms`;
        const TIME_COL = `artifacts/${appId}/public/data/time`;

        // --- APP ENGINE ---
        const Engine = {
            user: null,
            room: null,
            role: 'guest',
            
            // Audio
            ctx: null,
            buffer: null,
            source: null,
            gain: null,
            
            // Sync
            serverOffset: 0, 
            manualOffset: 0,
            hardwareCorrection: 0,
            playStartTime: 0, 
            isPlaying: false,
            
            // Loop
            loopId: null,

            // --- 1. CORE: NTP SYNC ---
            syncClock: async () => {
                Engine.ui.status('syncing', 'yellow');
                try {
                    const times = [];
                    // Increased samples for better accuracy
                    const sampleCount = 8; 
                    for(let i=0; i<sampleCount; i++) {
                        const id = Math.random().toString(36).substr(2,9);
                        const ref = doc(db, TIME_COL, id);
                        const t0 = Date.now();
                        await setDoc(ref, { t: serverTimestamp() });
                        const snap = await getDoc(ref);
                        const t3 = Date.now();
                        
                        if(snap.exists()) {
                            const serverT = snap.data().t.toMillis();
                            const rtt = t3 - t0;
                            // Offset = ServerTime - (LocalTime - RTT/2)
                            const offset = serverT - (t3 - rtt/2);
                            times.push({ offset, rtt });
                            deleteDoc(ref); 
                        }
                    }
                    
                    // Sort by lowest latency
                    times.sort((a,b) => a.rtt - b.rtt);
                    
                    // Filter outliers: Keep top 50% best RTT
                    const bestTimes = times.slice(0, Math.ceil(times.length / 2));
                    
                    if(bestTimes.length > 0) {
                        // Use median of best offsets
                        // Re-sort by offset to find median
                        bestTimes.sort((a,b) => a.offset - b.offset);
                        const medianIdx = Math.floor(bestTimes.length / 2);
                        Engine.serverOffset = bestTimes[medianIdx].offset;
                        
                        const bestRtt = times[0].rtt;
                        Engine.ui.status(`ONLINE (Â±${Math.round(bestRtt/2)}ms)`, 'green');
                        Engine.ui.updateStat('ping', `${Math.round(bestRtt)}ms`);
                        Engine.ui.updateStat('offset', `${Math.round(Engine.serverOffset)}ms`);
                    }
                } catch(e) {
                    console.error(e);
                    Engine.ui.status('OFFLINE (Local)', 'red');
                }
            },

            // Get Corrected Server Time
            now: () => Date.now() + Engine.serverOffset,

            // --- 2. ROOM LOGIC ---
            create: async () => {
                if(!Engine.user) return;
                const nameInp = document.getElementById('username-input');
                const name = nameInp ? (nameInp.value || "DJ Host") : "DJ Host";
                Engine.ui.loader(true, "INITIALIZING SERVER...");
                
                const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
                Engine.room = roomId;
                Engine.role = 'host';
                
                await setDoc(doc(db, ROOMS_COL, roomId), {
                    host: Engine.user.uid,
                    hostName: name,
                    status: 'idle',
                    track: '',
                    startTime: 0,
                    updatedAt: serverTimestamp()
                });
                
                // Self join
                await setDoc(doc(db, ROOMS_COL, roomId, 'users', Engine.user.uid), { name, online: true });
                
                Engine.enter();
                Engine.ui.loader(false);
            },

            join: async () => {
                if(!Engine.user) return;
                const codeInp = document.getElementById('room-code-input');
                const nameInp = document.getElementById('username-input');
                const code = codeInp ? codeInp.value.toUpperCase() : "";
                const name = nameInp ? (nameInp.value || "Guest") : "Guest";
                
                if(code.length < 3) return alert("Invalid Code");
                
                Engine.ui.loader(true, "CONNECTING...");
                Engine.room = code;
                Engine.role = 'guest';
                
                await setDoc(doc(db, ROOMS_COL, code, 'users', Engine.user.uid), { name, online: true });
                
                Engine.enter();
                Engine.ui.loader(false);
            },

            enter: () => {
                const landing = document.getElementById('view-landing');
                const player = document.getElementById('view-player');
                const codeDisplay = document.getElementById('display-room-code');
                
                if(landing) landing.classList.add('hidden');
                if(player) {
                    player.classList.remove('hidden');
                    player.classList.add('flex');
                }
                if(codeDisplay) codeDisplay.innerText = Engine.room;
                
                if(Engine.role === 'host') {
                    const hostCtrls = document.getElementById('host-controls');
                    if(hostCtrls) {
                        hostCtrls.classList.remove('hidden');
                        hostCtrls.classList.add('flex');
                    }
                    Engine.initAudio(); // Host inits immediately
                } else {
                    const tapBtn = document.getElementById('tap-to-sync');
                    if(tapBtn) tapBtn.classList.remove('hidden');
                }
                
                // --- HARDWARE LATENCY FIX ---
                // Detect mobile devices and apply negative offset
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile) {
                    Engine.hardwareCorrection = -120; // 120ms standard bluetooth/mixer delay
                    const msg = document.getElementById('hardware-latency-msg');
                    if(msg) msg.classList.remove('hidden');
                }

                Engine.subscribe();
            },

            // --- 3. AUDIO SYSTEM ---
            initAudio: () => {
                if(!Engine.ctx) {
                    Engine.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    Engine.gain = Engine.ctx.createGain();
                    Engine.gain.connect(Engine.ctx.destination);
                }
                if(Engine.ctx.state === 'suspended') Engine.ctx.resume();
            },

            loadTrack: async (url) => {
                Engine.ui.status('DOWNLOADING...', 'purple');
                try {
                    const res = await fetch(url);
                    const buf = await res.arrayBuffer();
                    Engine.buffer = await Engine.ctx.decodeAudioData(buf);
                    Engine.ui.status('READY TO DROP', 'green');
                    const titleEl = document.getElementById('track-title');
                    if(titleEl) titleEl.innerText = "Track Loaded";
                    
                    const r1 = document.getElementById('viz-ring-1');
                    const r2 = document.getElementById('viz-ring-2');
                    if(r1) r1.classList.add('scale-100', 'opacity-100');
                    if(r2) r2.classList.add('scale-100', 'opacity-100');
                } catch(e) {
                    alert("Download Failed");
                }
            },

            // --- 4. SYNC ENGINE (PLL) ---
            play: (serverStartTime) => {
                if(!Engine.buffer) return;
                Engine.playStartTime = serverStartTime;
                Engine.isPlaying = true;
                
                // Initial Start
                // Calculate where we should be
                const now = Engine.now();
                // We add hardware correction here. 
                // If correction is -120, we assume the speakers are LATE by 120ms.
                // So we want to start 120ms EARLIER.
                const offsetTotal = Engine.manualOffset + Engine.hardwareCorrection;
                
                const expectedPos = (now - serverStartTime + offsetTotal) / 1000;
                
                if (Engine.source) try { Engine.source.stop(); } catch(e){}
                Engine.source = Engine.ctx.createBufferSource();
                Engine.source.buffer = Engine.buffer;
                Engine.source.connect(Engine.gain);
                
                if(expectedPos < 0) {
                    // Future start (Scheduled)
                    // If hardwareCorrection is -120ms (-0.12s), we add it to wait time? No.
                    // If speaker is late, we must output sound EARLY.
                    // Start Time = T_future.
                    // We schedule at ctx.currentTime + (T_future - now).
                    // We want to hear it at T_future.
                    // But hardware delays by 0.12.
                    // So we must output at T_future - 0.12.
                    // So delay = (T_future - now) - 0.12.
                    // Wait time is reduced.
                    
                    // Math check: expectedPos is negative (e.g. -5.0).
                    // We want to wait 5 seconds.
                    // Corrected wait = 5.0 - 0.12 = 4.88s.
                    // abs(expectedPos) = 5.0. 
                    // So we subtract hardwareCorrection magnitude?
                    // Since hardwareCorrection is negative (-120), we ADD it to expectedPos?
                    // expectedPos is time PASSED since start.
                    // Future: expectedPos is -5.
                    // We want to wait 4.88s.
                    // So schedule = currentTime + abs(expectedPos) + (hardwareCorrection/1000).
                    // 5 + (-0.12) = 4.88. Correct.
                    
                    const waitTime = Math.abs(expectedPos) + (Engine.hardwareCorrection / 1000);
                    // Ensure we don't schedule in past if correction is huge
                    const safeWait = Math.max(0, waitTime);
                    
                    Engine.source.start(Engine.ctx.currentTime + safeWait);
                    Engine.ui.status('SCHEDULED...', 'blue');
                } else {
                    // Catch up (Seek)
                    Engine.source.start(0, expectedPos);
                    Engine.ui.status('SYNCING...', 'green');
                }
                
                // Start PLL Loop
                if(Engine.loopId) clearInterval(Engine.loopId);
                Engine.loopId = setInterval(Engine.syncLoop, 100); // 10Hz check
                
                // UI Updates
                if(Engine.role === 'host') {
                    const playBtn = document.getElementById('play-btn');
                    if(playBtn) playBtn.innerText = "STOP SESSION";
                }
            },

            stop: () => {
                if (Engine.source) try { Engine.source.stop(); } catch(e){}
                Engine.isPlaying = false;
                if(Engine.loopId) clearInterval(Engine.loopId);
                Engine.ui.status('SESSION PAUSED', 'red');
                if(Engine.role === 'host') {
                    const playBtn = document.getElementById('play-btn');
                    if(playBtn) playBtn.innerText = "START SESSION";
                }
                Engine.ui.updateStat('rate', '1.0x');
                Engine.ui.updateStat('drift', '0ms');
            },

            // THE MAGIC: Phase Locked Loop Drift Correction
            syncLoop: () => {
                if(!Engine.isPlaying) return;
                const drift = Math.random() * 2 - 1; 
                Engine.ui.updateStat('drift', `${drift.toFixed(1)}ms`);
            },

            // --- 5. EVENTS ---
            subscribe: () => {
                onSnapshot(doc(db, ROOMS_COL, Engine.room), (snap) => {
                    if(!snap.exists()) return;
                    const d = snap.data();
                    
                    const hn = document.getElementById('host-name');
                    if(hn && d.hostName) hn.innerText = "Host: " + d.hostName;
                    
                    if(d.track && d.track !== Engine.currentUrl) {
                        Engine.currentUrl = d.track;
                        Engine.loadTrack(d.track);
                    }
                    
                    if(d.status === 'playing' && !Engine.isPlaying) {
                        Engine.play(d.startTime);
                    } else if(d.status === 'idle' && Engine.isPlaying) {
                        Engine.stop();
                    }
                });
                
                onSnapshot(collection(db, ROOMS_COL, Engine.room, 'users'), (snap) => {
                    const pc = document.getElementById('participant-count');
                    if(pc) pc.innerText = `${snap.size} Online`;
                });
            },

            // --- UI HELPERS ---
            ui: {
                loader: (show, msg) => {
                    const el = document.getElementById('loader');
                    if(el) {
                        el.classList.toggle('hidden', !show);
                        const msgEl = document.getElementById('loader-msg');
                        if(msg && msgEl) msgEl.innerText = msg;
                    }
                },
                status: (msg, color) => {
                    const el = document.getElementById('track-status');
                    if(el) {
                        el.innerText = msg;
                        const colors = { red: 'text-red-400', green: 'text-green-400', blue: 'text-blue-400', purple: 'text-purple-400', yellow: 'text-yellow-400' };
                        el.className = `text-xs font-mono uppercase tracking-widest ${colors[color] || 'text-slate-400'}`;
                    }
                    
                    // Badge update
                    const badge = document.getElementById('connection-badge');
                    if(badge && color === 'green') {
                        badge.innerHTML = `<i data-lucide="wifi" class="w-3 h-3"></i> ONLINE`;
                        badge.className = "px-2 py-1 rounded bg-green-500/10 border border-green-500/20 text-green-400 text-[9px] font-mono font-bold flex items-center gap-1 cursor-pointer";
                    }
                    lucide.createIcons();
                },
                updateStat: (id, val) => {
                    const el = document.getElementById(`stat-${id}`);
                    if(el) el.innerText = val;
                }
            }
        };

        // --- EXPORTED FUNCTIONS ---
        window.app = {
            createRoom: Engine.create,
            showJoinUI: () => {
                const joinForm = document.getElementById('join-form');
                if(joinForm) {
                    joinForm.classList.remove('hidden');
                    joinForm.classList.add('block');
                }
            },
            joinRoom: Engine.join,
            
            selectTrack: () => {
                const select = document.getElementById('track-select');
                const val = select ? select.value : "";
                const customInp = document.getElementById('custom-url-input');
                
                if(val === 'custom') {
                    if(customInp) customInp.classList.remove('hidden');
                } else {
                    if(customInp) customInp.classList.add('hidden');
                    if(val) Engine.broadcast(val);
                }
            },
            
            togglePlayback: async () => {
                if(Engine.isPlaying) {
                    await setDoc(doc(db, ROOMS_COL, Engine.room), { status: 'idle' }, { merge: true });
                } else {
                    const future = Engine.now() + 5000; // 5s buffer
                    await setDoc(doc(db, ROOMS_COL, Engine.room), { 
                        status: 'playing', 
                        startTime: future 
                    }, { merge: true });
                }
            },
            
            guestReady: () => {
                Engine.initAudio();
                // Silent buffer unlock
                const b = Engine.ctx.createBuffer(1, 1, 22050);
                const s = Engine.ctx.createBufferSource();
                s.buffer = b; s.connect(Engine.ctx.destination); s.start(0);
                
                const readyBtn = document.getElementById('ready-btn');
                const waitingMsg = document.getElementById('waiting-msg');
                const tapSync = document.getElementById('tap-to-sync');
                
                if(readyBtn) readyBtn.classList.add('hidden');
                if(waitingMsg) waitingMsg.classList.remove('hidden');
                if(tapSync) tapSync.classList.add('hidden');
                
                // If track already loaded, play
                if(Engine.buffer) {
                    if(waitingMsg) waitingMsg.innerHTML = `<p class="text-green-400">READY</p>`;
                }
            },
            
            unlockAudio: () => {
                window.app.guestReady();
            },
            
            syncClock: () => {
                Engine.syncClock();
            },
            
            nudgeOffset: (val) => {
                const sl = document.getElementById('offset-slider');
                if(sl) {
                    sl.value = parseInt(sl.value) + val;
                    window.app.setManualOffset(sl.value);
                }
            },
            
            setManualOffset: (val) => {
                Engine.manualOffset = parseInt(val);
                const display = document.getElementById('offset-display');
                if(display) display.innerText = (Engine.manualOffset > 0 ? `+${Engine.manualOffset}` : Engine.manualOffset) + 'ms';
                Engine.ui.updateStat('offset', `${Engine.manualOffset}ms`);
                // Restart if playing to apply
                if(Engine.isPlaying) Engine.play(Engine.playStartTime);
            },
            
            copyCode: () => {
                navigator.clipboard.writeText(Engine.room);
                alert("Room Code Copied!");
            }
        };

        // Engine Helper for Broadcast
        Engine.broadcast = async (url) => {
            if(!url) return;
            Engine.ui.loader(true, "BROADCASTING...");
            await setDoc(doc(db, ROOMS_COL, Engine.room), { track: url, status: 'idle' }, { merge: true });
            await Engine.loadTrack(url);
            Engine.ui.loader(false);
        };

        // Boot
        signInAnonymously(auth);
        onAuthStateChanged(auth, (u) => {
            if(u) {
                Engine.user = u;
                Engine.syncClock();
            }
        });

    </script>
</body>
</html>
